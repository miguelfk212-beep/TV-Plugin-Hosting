<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradingView TA Plugin</title>
    <style>
        /* Asegura que el widget ocupe todo el espacio disponible en el WebView */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #1e222d; /* Color de fondo oscuro por defecto */
        }
        #tv_widget_container {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>

<div id="tv_widget_container"></div>

<script>
    // Esta función se encarga de crear o recrear el widget de TradingView con un símbolo específico.
    function createTechnicalAnalysisWidget(symbol) {
        // Limpiar cualquier widget existente antes de crear uno nuevo
        document.getElementById('tv_widget_container').innerHTML = '';

        // Definición de la configuración del widget
        const widgetConfig = {
            "interval": "1m",
            "width": "100%", 
            "height": "100%",
            "symbol": symbol, // El símbolo que cTrader enviará dinámicamente
            "showSae": false,
            "locale": "es", // Idioma español
            "colorTheme": "dark", // Tema oscuro, como en tu imagen
            "displayMode": "single" // Modo de resumen simple
        };

        // Crear el elemento script y configurarlo
        var script = document.createElement('script');
        script.src = 's3.tradingview.com';
        script.async = true;
        script.text = JSON.stringify(widgetConfig);

        // Añadir el script al contenedor en el cuerpo de la página
        document.getElementById('tv_widget_container').appendChild(script);
    }

    // Esta es la función CLAVE que será llamada desde el código C# del plugin de cTrader.
    // cTrader usará ExecuteScript() para llamar a 'setSymbol("SPX500")' por ejemplo.
    window.setSymbol = function(symbol) {
        console.log("cTrader ha solicitado cambiar el símbolo a: " + symbol);
        // Formatear símbolos si es necesario para que TradingView los entienda correctamente
        const formattedSymbol = formatSymbolForTradingView(symbol);
        createTechnicalAnalysisWidget(formattedSymbol);
    }

    // Función auxiliar para mapear símbolos de cTrader a tickers de TradingView
    function formatSymbolForTradingView(cTraderSymbol) {
        // Usa un mapeo para asegurar la compatibilidad con índices globales
        switch(cTraderSymbol) {
            case "SPX500":
            case "US500":
                return "INDEX:SPX"; // Standard & Poor's 500
            case "NAS100":
            case "US100":
                return "NASDAQ:NDX"; // Nasdaq 100
            case "GER40":
            case "DE40":
                return "INDEX:DEU40"; // DAX 40
            // Añade más casos para otros índices si es necesario
            default:
                return cTraderSymbol; // Devuelve el símbolo tal cual si no hay un mapeo especial (funciona para Forex)
        }
    }

    // Cargar un índice por defecto (ej. S&P 500) cuando la página se carga por primera vez
    document.addEventListener('DOMContentLoaded', (event) => {
        createTechnicalAnalysisWidget("INDEX:SPX");
    });
</script>

</body>
</html>
