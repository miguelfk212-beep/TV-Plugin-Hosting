<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widget de TradingView para cTrader</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: #1e1e1e;
            font-family: Arial, sans-serif;
            color: #ffffff;
        }
        
        .main-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }
        
        .control-panel {
            background-color: #2a2a2a;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #444;
            flex-wrap: wrap;
        }
        
        .selectors-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .selector-group {
            display: flex;
            align-items: center;
        }

        .selector-group label {
            margin-right: 5px;
            font-size: 12px;
        }
        
        select {
            background-color: #3a3a3a;
            color: #ffffff;
            border: 1px solid #555;
            padding: 4px 8px;
            border-radius: 4px;
            min-width: 200px; /* Un poco más ancho al ser el único selector */
            font-size: 12px;
        }
        
        .update-button {
            background-color: #0066cc;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 12px;
        }
        
        .update-button:hover {
            background-color: #0052a3;
        }
        
        #tradingview-widget-container {
            flex-grow: 1;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="control-panel">
            <div class="selectors-container">
                <!-- Solo queda el selector de activos -->
                <div class="selector-group">
                    <label for="symbol-select">Activo:</label>
                    <select id="symbol-select">
                        <!-- Índices con SÍMBOLOS CORREGIDOS Y VERIFICADOS -->
                        <optgroup label="Americanos">
                            <option value="INDEX:SPX">US 500 (S&P 500)</option>
                            <option value="DJ:DJI">US 30 (Dow Jones)</option>
                            <option value="NASDAQ:NDX">US Tech 100 (NASDAQ)</option>
                            <option value="INDEX:RUT">Russell 2000</option>
                            <option value="CBOE:VIX">VIX</option>
                        </optgroup>
                        
                        <optgroup label="Europeos">
                            <option value="STOXX:50E">Europa 50 (STOXX 50)</option>
                            <option value="XETR:DAX">Alemania 40 (DAX)</option>
                            <option value="UKX">Reino Unido 100 (FTSE)</option>
                            <option value="EURONEXT:PX1">Francia 40 (CAC)</option>
                            <option value="IBEX">España 35 (IBEX)</option>
                            <option value="FTSEMIB:FTSEMIB">Italia 40 (FTSE MIB)</option>
                        </optgroup>
                        
                        <optgroup label="Asiáticos">
                            <option value="INDEX:NKY">Japón 225 (Nikkei)</option>
                            <option value="HSI:HSI">Hong Kong 50 (Hang Seng)</option>
                            <option value="SSE:000001">Shanghai Composite</option>
                            <option value="KRX:KOSPI">KOSPI</option>
                            <option value="ASX:XJO">Australia 200 (ASX)</option>
                        </optgroup>
                        
                        <optgroup label="Materias Primas">
                            <option value="NYMEX:CL1">Petróleo WTI</option>
                            <option value="NYMEX:BB1">Petróleo Brent</option>
                            <option value="TVC:GOLD">Oro</option>
                            <option value="TVC:SILVER">Plata</option>
                            <option value="NYMEX:NG1">Gas Natural</option>
                        </optgroup>
                    </select>
                </div>
            </div>
            
            <button class="update-button" onclick="updateWidget()">Actualizar</button>
        </div>
        
        <div id="tradingview-widget-container"></div>
    </div>

    <script>
        // Mapeo de símbolos de cTrader a los de TradingView
        const cTraderToTvMap = {
            'SPX500': 'INDEX:SPX', 'US500': 'INDEX:SPX',
            'NAS100': 'NASDAQ:NDX', 'US100': 'NASDAQ:NDX',
            'US30': 'DJ:DJI', 'DOW': 'DJ:DJI',
            'GER40': 'XETR:DAX', 'DAX': 'XETR:DAX',
            'UK100': 'UKX', 'FTSE': 'UKX',
            'ESP35': 'IBEX', 'IBEX': 'IBEX',
            'EU50': 'STOXX:50E', 'STXE': 'STOXX:50E'
        };

        function updateWidget() {
            // 1. Obtener solo el símbolo
            const symbol = document.getElementById('symbol-select').value;
            
            console.log("Actualizando widget con el símbolo:", symbol);

            const container = document.getElementById('tradingview-widget-container');
            container.innerHTML = '';
            
            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.async = true;
            script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-technical-analysis.js';
            
            // 2. Definir la configuración del widget
            script.innerHTML = JSON.stringify({
                "width": "100%",
                "height": "100%",
                "isTransparent": false,
                "symbol": symbol,
                "showIntervalTabs": true, // ¡IMPORTANTE! Reactivamos las pestañas de tiempo
                "displayMode": "single",
                "locale": "es",
                "colorTheme": "dark"
            });
            
            container.appendChild(script);
        }
        
        /**
         * Función GLOBAL para que cTrader pueda cambiar el símbolo.
         */
        function setSymbol(cTraderSymbolName) {
            console.log("Llamada desde cTrader para setSymbol con:", cTraderSymbolName);
            
            const tvSymbol = cTraderToTvMap[cTraderSymbolName] || cTraderSymbolName;
            
            const symbolSelect = document.getElementById('symbol-select');
            symbolSelect.value = tvSymbol;
            
            updateWidget();
        }

        function initializeWidget() {
            const urlParams = new URLSearchParams(window.location.search);
            const cTraderSymbolFromUrl = urlParams.get('symbol');

            if (cTraderSymbolFromUrl) {
                setSymbol(cTraderSymbolFromUrl);
            } else {
                updateWidget();
            }
        }

        window.onload = initializeWidget;
    </script>
</body>
</html>
